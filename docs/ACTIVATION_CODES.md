# Система кодов активации

## Обзор

Система кодов активации позволяет администратору контролировать количество VPN конфигураций, которые может создать каждый пользователь.

## Принцип работы

1. **Новые пользователи** получают лимит = 0 по умолчанию
2. **Для создания конфигураций** пользователь должен активировать код командой `/code`
3. **Коды активации** - одноразовые, состоят из 10 символов (латинские буквы + цифры)
4. **Каждый код** имеет поле `limit`, которое добавляется к текущему лимиту пользователя
5. **Проверка лимита** происходит при каждой попытке создать конфигурацию

## Управление кодами

### Создание кодов

```bash
# Создать 5 кодов с лимитом 1
make generate-codes

# Создать коды с кастомными параметрами
make generate-codes-custom LIMIT=5 COUNT=10
```

### Прямое использование утилиты

```bash
# Собрать утилиту
make build

# Создать коды
./bin/ovpn-admin -limit=3 -count=5
```

### Параметры утилиты

- `-limit` - количество конфигураций, которое добавляется к лимиту пользователя
- `-count` - количество кодов для генерации

## Структура кодов

### Формат кода
- **Длина**: 10 символов
- **Символы**: латинские буквы (a-z, A-Z) и цифры (0-9)
- **Пример**: `AbC123XyZ9`

### Статусы кода
- `active` - код активен и может быть использован
- `used` - код уже использован и не может быть активирован повторно

## Использование в боте

### Команда `/code`

1. Пользователь отправляет `/code`
2. Бот запрашивает ввод кода активации
3. Пользователь вводит 10-символьный код
4. Бот проверяет код и обновляет лимит пользователя
5. Код помечается как использованный

### Проверка лимита

При попытке создать конфигурацию командой `/add`:
- Если `limit <= количество_конфигураций` - создание блокируется
- Если `limit > количество_конфигураций` - создание разрешено

## База данных

### Таблица `activation_codes`

```sql
CREATE TABLE activation_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code TEXT UNIQUE NOT NULL,
    status TEXT DEFAULT 'active',
    limit_count INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Поле `limit_count` в таблице `users`

```sql
ALTER TABLE users ADD COLUMN limit_count INTEGER DEFAULT 0;
```

## Примеры использования

### Создание кодов для разных сценариев

```bash
# Коды для тестирования (лимит 1)
make generate-codes-custom LIMIT=1 COUNT=10

# Коды для VIP пользователей (лимит 10)
make generate-codes-custom LIMIT=10 COUNT=5

# Коды для обычных пользователей (лимит 3)
make generate-codes-custom LIMIT=3 COUNT=20
```

### Проверка кодов в базе данных

```sql
-- Показать все активные коды
SELECT * FROM activation_codes WHERE status = 'active';

-- Показать использованные коды
SELECT * FROM activation_codes WHERE status = 'used';

-- Показать коды с определенным лимитом
SELECT * FROM activation_codes WHERE limit_count = 5;
```

## Безопасность

- Коды генерируются криптографически стойким генератором
- Каждый код уникален (UNIQUE constraint в БД)
- Коды одноразовые - повторное использование невозможно
- Нет связи между кодами и пользователями (анонимность)

## Мониторинг

### Логи активации

Все операции активации кодов логируются в stdout бота:
- Успешная активация
- Ошибки валидации кода
- Попытки повторного использования

### Статистика использования

```sql
-- Количество использованных кодов
SELECT COUNT(*) FROM activation_codes WHERE status = 'used';

-- Общий лимит, выданный через коды
SELECT SUM(limit_count) FROM activation_codes WHERE status = 'used';

-- Средний лимит на код
SELECT AVG(limit_count) FROM activation_codes WHERE status = 'used';
```
